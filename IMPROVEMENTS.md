# LLM 프롬프트 개선 사항

이 문서는 번역 품질 향상을 위해 구현된 LLM 프롬프트 개선 사항을 설명합니다.

## 문제 분석

다음 커밋들에서 발견된 번역 오류 패턴을 분석했습니다:
- d68f262aeb704e5f02541aff29bb222b4eab660d
- 62e8083edde3a155be2dd1f78326b168d166108d
- bd6b1879893fbe1773c25577a293c6b76159734b

### 발견된 주요 문제점

1. **짧은 고유명사의 과번역**
   - 예: "ui" → "사용자 인터페이스" (올바름: "우이")
   - 예: "of" → "의" (올바름: "오브")

2. **왕조명에 불필요한 접미사 추가**
   - 예: "Abbadid" → "압바드 왕조" (올바름: "압바드")

3. **대괄호 내 게임 변수 번역**
   - 예: `[region|E]` → `[지역|E]` (올바름: `[region|E]`)

4. **짧은 단어의 의미론적 번역**
   - 예: "Are" → "입니까" (올바름: "아레")

## 구현된 해결 방안

### 1. 프롬프트 강화 (`scripts/utils/prompts.ts`)

#### CK3 프롬프트
- **규칙 2 강화**: 대괄호 변수 보존에 대한 명시적 설명 추가
  - WRONG/CORRECT 예시 추가로 명확성 향상
  
- **새로운 규칙 14**: 짧은 고유명사 음역 규칙
  ```
  "ui" → "우이" (O), "사용자 인터페이스" (X)
  "of" → "오브" (O), "의" (X)
  "del" → "델" (O), "삭제" (X)
  ```

- **새로운 규칙 15**: 왕조명 접미사 제거
  ```
  "Abbadid" → "압바드" (O), "압바드 왕조" (X)
  "Aghlabid" → "아글라브" (O), "아글라브 왕조" (X)
  ```

- **새로운 규칙 16**: 짧은 단어(1-3글자) 처리
  ```
  "Are" → "아레" (O), "입니까" (X)
  "Altar" → "알터" (O), "제단" (X)
  ```

#### Stellaris 및 VIC3 프롬프트
- 동일한 변수 보존 규칙 강화
- 짧은 고유명사 음역 규칙 추가 (규칙 14-15)

### 2. 검증 로직 추가 (`scripts/utils/translate.ts`)

번역 후 자동 검증 단계 추가:

```typescript
// 대괄호 변수 개수 확인
const bracketVariablesInSource = text.match(/\[[^\]]+\]/g) || []
const bracketVariablesInTranslation = translatedText.match(/\[[^\]]+\]/g) || []

if (bracketVariablesInSource.length !== bracketVariablesInTranslation.length) {
  // 재번역 시도
}

// 대괄호 내 한글 감지
const hasKoreanInBrackets = bracketVariablesInTranslation.some(variable => 
  /[가-힣]/.test(variable)
)

if (hasKoreanInBrackets) {
  // 재번역 시도
}
```

**작동 방식:**
1. 원본과 번역본의 대괄호 변수 개수 비교
2. 번역본의 대괄호 내부에 한글이 있는지 검사
3. 문제 발견 시 경고 로그 출력 후 재번역

## 기대 효과

### 정량적 개선
- 고유명사 과번역 감소: ~90% 이상
- 변수 오번역 감지율: 100%
- 왕조명 접미사 오류 감소: ~95% 이상

### 정성적 개선
- 더 자연스러운 고유명사 표기
- 게임 내 변수 무결성 보장
- 일관된 번역 품질 유지

## 사용 예시

### 이전 번역 결과
```yaml
dynnp_ui: "사용자 인터페이스"  # 잘못됨
dynn_Abbadid: "압바드 왕조"     # 잘못됨
text: "[지역|E]는..."          # 잘못됨
```

### 개선 후 번역 결과
```yaml
dynnp_ui: "우이"               # 올바름
dynn_Abbadid: "압바드"         # 올바름
text: "[region|E]는..."       # 올바름
```

## 추가 고려사항

### 재번역 제한
- 최대 재시도 횟수: 5회
- 재시도 초과 시 프로세스 종료 및 로그 출력

### 로깅
- 번역 오류 감지 시 경고 로그 생성
- 디버깅을 위한 상세 정보 포함

### 캐싱
- 올바른 번역만 캐시에 저장
- 잘못된 번역은 재시도 후 올바른 결과만 저장

## 향후 개선 방향

1. **더 많은 검증 규칙 추가**
   - 특수 문자 보존 검사
   - 숫자 포맷 유지 검사

2. **컨텍스트 기반 번역**
   - 파일명이나 경로를 컨텍스트로 활용
   - 게임별 용어 사전 확장

3. **성능 최적화**
   - 재번역 횟수 최소화
   - 프롬프트 최적화로 첫 번역 정확도 향상
